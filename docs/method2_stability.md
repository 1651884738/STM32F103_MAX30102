# æ–¹æ³•2å¿ƒç‡ç¨³å®šæ€§ä¼˜åŒ–è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆæ–¹æ³•2ï¼ˆDPTé¢‘åŸŸç®—æ³•ï¼‰çš„å¿ƒç‡æ³¢åŠ¨æ¯”è¾ƒå¤§ï¼Œéœ€è¦å¢å¼ºç¨³å®šæ€§ã€‚

## ä¼˜åŒ–æªæ–½

### 1. å¢åŠ ä¸­ä½æ•°æ»¤æ³¢ ğŸ¯ **å…³é”®ä¼˜åŒ–**

**ä½ç½®**: `ppg_algorithm_v2.c:124`

**åŠŸèƒ½**: 7ç‚¹ä¸­ä½æ•°æ»¤æ³¢å¯æœ‰æ•ˆå»é™¤çªå‘çš„å¼‚å¸¸å€¼

**å®ç°**:
```c
// 1. Add to median filter buffer
state->hr_median_buffer[state->hr_median_index] = raw_hr;
state->hr_median_index = (state->hr_median_index + 1) % DPT_MEDIAN_SIZE;

// 2. Apply median filter (7-point)
float median_hr = median_filter(state->hr_median_buffer, DPT_MEDIAN_SIZE);
```

**æ•ˆæœ**: è¿‡æ»¤æ‰å³°å€¼æ£€æµ‹ä¸­çš„å¶ç„¶é”™è¯¯ï¼Œæé«˜é²æ£’æ€§

---

### 2. æ·»åŠ å˜åŒ–ç‡é™åˆ¶ ğŸ¯ **å…³é”®ä¼˜åŒ–**

**ä½ç½®**: `ppg_algorithm_v2.c:127-134`

**åŠŸèƒ½**: é™åˆ¶å¿ƒç‡æ¯æ¬¡æœ€å¤§å˜åŒ–ä¸ºÂ±8 bpm

**å®ç°**:
```c
// 3. Rate limiting: prevent large jumps
if (state->last_valid_hr > 0.0f) {
    float hr_diff = median_hr - state->last_valid_hr;
    if (hr_diff > DPT_MAX_HR_CHANGE) {
        median_hr = state->last_valid_hr + DPT_MAX_HR_CHANGE;
    } else if (hr_diff < -DPT_MAX_HR_CHANGE) {
        median_hr = state->last_valid_hr - DPT_MAX_HR_CHANGE;
    }
}
```

**å‚æ•°**: `DPT_MAX_HR_CHANGE = 8.0f` (å¯è°ƒ)

**æ•ˆæœ**: é˜²æ­¢å¿ƒç‡çªç„¶è·³å˜ï¼Œä½¿æ˜¾ç¤ºæ›´å¹³æ»‘

---

### 3. æ·»åŠ EMAæŒ‡æ•°å¹³æ»‘ ğŸ¯ **å…³é”®ä¼˜åŒ–**

**ä½ç½®**: `ppg_algorithm_v2.c:136-144`

**åŠŸèƒ½**: ä½¿ç”¨æŒ‡æ•°ç§»åŠ¨å¹³å‡è¿›ä¸€æ­¥å¹³æ»‘å¿ƒç‡

**å®ç°**:
```c
// 4. EMA smoothing
if (state->ema_hr == 0.0f) {
    state->ema_hr = median_hr;
} else {
    state->ema_hr = DPT_HR_EMA_ALPHA * median_hr +
                   (1.0f - DPT_HR_EMA_ALPHA) * state->ema_hr;
}
```

**å‚æ•°**: `DPT_HR_EMA_ALPHA = 0.15f`
- Î±è¶Šå° â†’ è¶Šå¹³æ»‘ä½†å“åº”è¶Šæ…¢
- Î±è¶Šå¤§ â†’ å“åº”è¶Šå¿«ä½†å¯èƒ½ä¸å¤Ÿå¹³æ»‘

**æ•ˆæœ**: æä¾›æ—¶é—´åŸŸçš„è¿ç»­å¹³æ»‘

---

### 4. æ·»åŠ ç¨³å®šæ€§éªŒè¯ â„¹ï¸ **ä¼˜åŒ–**

**ä½ç½®**: `ppg_algorithm_v2.c:150-159`

**åŠŸèƒ½**: åªæœ‰è¿ç»­2æ¬¡å˜åŒ–å°äº3 bpmæ‰æ ‡è®°ä¸ºæœ‰æ•ˆ

**å®ç°**:
```c
// 6. Stability validation
float change = fabsf(state->heart_rate - state->last_valid_hr);
if (change < 3.0f) {
    state->stable_count++;
} else {
    state->stable_count = 0;
}

// 7. Mark as valid if stable for at least 2 readings
state->hr_valid = (state->stable_count >= 2);
```

**æ•ˆæœ**: è¿‡æ»¤æ‰ä¸ç¨³å®šçš„åˆå§‹æµ‹é‡å€¼

---

### 5. é™ä½æ›´æ–°é¢‘ç‡ â„¹ï¸ **ä¼˜åŒ–**

**ä½ç½®**: `main.c:392`

**ä¿®æ”¹å‰**: æ¯100ä¸ªæ ·æœ¬ï¼ˆ1ç§’ï¼‰æ›´æ–°
**ä¿®æ”¹å**: æ¯250ä¸ªæ ·æœ¬ï¼ˆ2.5ç§’ï¼‰æ›´æ–°

**å®ç°**:
```c
// 3. æ¯250ä¸ªæ ·æœ¬ï¼ˆ2.5ç§’@100Hzï¼‰æ›´æ–°æ˜¾ç¤º
sample_counter++;
if (sample_counter >= 250) {
    // æ›´æ–°å¿ƒç‡å’ŒSpO2
}
```

**æ•ˆæœ**: é™ä½æ›´æ–°é¢‘ç‡ï¼Œå‡å°‘è§†è§‰ä¸Šçš„è·³åŠ¨æ„Ÿ

---

### 6. å¢å¼ºSpO2å¹³æ»‘ â„¹ï¸ **ä¼˜åŒ–**

**ä½ç½®**: `main.c:404`

**ä¿®æ”¹å‰**: `Î± = 0.1` (90%å†å²ï¼Œ10%æ–°å€¼)
**ä¿®æ”¹å**: `Î± = 0.15` (85%å†å²ï¼Œ15%æ–°å€¼)

**å®ç°**:
```c
displayed_spo2 = 0.15f * spo2 + 0.85f * displayed_spo2;
```

**æ•ˆæœ**: ç•¥å¾®æé«˜SpO2çš„å“åº”é€Ÿåº¦

---

### 7. å¢åŠ å¹³æ»‘çª—å£å¤§å° â„¹ï¸ **ä¼˜åŒ–**

**ä½ç½®**: `ppg_algorithm_v2.h:37`

**ä¿®æ”¹**:
```c
#define DPT_HR_SMOOTH_SIZE  7   // ä»5å¢åŠ åˆ°7
#define DPT_MEDIAN_SIZE     7   // æ–°å¢ä¸­ä½æ•°æ»¤æ³¢
```

**æ•ˆæœ**: æ›´å¤§çš„çª—å£æä¾›æ›´å¼ºçš„å¹³æ»‘

---

## å®Œæ•´çš„ä¿¡å·å¤„ç†æµç¨‹

```
åŸå§‹å¿ƒç‡(ä»å³°å€¼å‘¨æœŸè®¡ç®—)
         â†“
    ä¸­ä½æ•°æ»¤æ³¢ (7ç‚¹)         â† å»é™¤å¼‚å¸¸å€¼
         â†“
    å˜åŒ–ç‡é™åˆ¶ (Â±8 bpm)      â† é˜²æ­¢çªå˜
         â†“
    EMAå¹³æ»‘ (Î±=0.15)         â† æ—¶åŸŸå¹³æ»‘
         â†“
    ç¨³å®šæ€§éªŒè¯ (è¿ç»­2æ¬¡)     â† ç¡®ä¿å¯é 
         â†“
    æœ€ç»ˆå¿ƒç‡è¾“å‡º
```

---

## å‚æ•°è°ƒä¼˜å»ºè®®

### éœ€è¦æ›´å¹³æ»‘çš„æ˜¾ç¤º

```c
#define DPT_HR_EMA_ALPHA    0.10f   // é™ä½Î±ï¼Œæ›´å¼ºå¹³æ»‘
#define DPT_MAX_HR_CHANGE   6.0f    // é™ä½æœ€å¤§å˜åŒ–
#define DPT_MEDIAN_SIZE     9       // å¢åŠ ä¸­ä½æ•°çª—å£
```

### éœ€è¦æ›´å¿«çš„å“åº”

```c
#define DPT_HR_EMA_ALPHA    0.20f   // æé«˜Î±ï¼Œæ›´å¿«å“åº”
#define DPT_MAX_HR_CHANGE   10.0f   // æé«˜æœ€å¤§å˜åŒ–
#define DPT_MEDIAN_SIZE     5       // å‡å°ä¸­ä½æ•°çª—å£
```

### å¹³è¡¡è®¾ç½®ï¼ˆæ¨èï¼‰

```c
#define DPT_HR_EMA_ALPHA    0.15f   // å½“å‰è®¾ç½®
#define DPT_MAX_HR_CHANGE   8.0f    // å½“å‰è®¾ç½®
#define DPT_MEDIAN_SIZE     7       // å½“å‰è®¾ç½®
```

---

## ä¸æ–¹æ³•1çš„å¯¹æ¯”

| ç¨³å®šæ€§æªæ–½ | æ–¹æ³•1 | æ–¹æ³•2 (ä¼˜åŒ–å) |
|-----------|-------|---------------|
| å»è¶‹åŠ¿æ»¤æ³¢ | âœ… 50ç‚¹MA | âŒ æ— ï¼ˆDPTè‡ªå¸¦ï¼‰ |
| Butterworthæ»¤æ³¢ | âœ… 4é˜¶ | âŒ æ— ï¼ˆDPTè‡ªå¸¦ï¼‰ |
| å³°å€¼æ£€æµ‹ | âœ… 7ç‚¹çª—å£ | âœ… é¢‘è°±å³°å€¼ |
| ä¸­ä½æ•°æ»¤æ³¢ | âœ… 7ç‚¹ | âœ… 7ç‚¹ |
| å˜åŒ–ç‡é™åˆ¶ | âœ… Â±6 bpm | âœ… Â±8 bpm |
| EMAå¹³æ»‘ | âœ… Î±=0.2 | âœ… Î±=0.15 |
| ç¨³å®šæ€§éªŒè¯ | âœ… 2æ¬¡ | âœ… 2æ¬¡ |
| æ˜¾ç¤ºå±‚å¹³æ»‘ | âœ… åŒå±‚ | âœ… å•å±‚ |
| æ›´æ–°é¢‘ç‡ | 2.5ç§’ | 2.5ç§’ |

---

## æµ‹è¯•å»ºè®®

### 1. ç¼–è¯‘å¹¶çƒ§å½•

```bash
make clean
make
st-flash write build/MAX30102.bin 0x8000000
```

### 2. è§‚å¯Ÿå¿ƒç‡ç¨³å®šæ€§

ä¼˜åŒ–ååº”è¯¥çœ‹åˆ°ï¼š
- âœ… å¿ƒç‡ä¸ä¼šçªç„¶è·³å˜è¶…è¿‡8 bpm
- âœ… æ˜¾ç¤ºå€¼å¹³æ»‘è¿‡æ¸¡
- âœ… 2.5ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘é—ªçƒæ„Ÿ
- âœ… åˆå§‹åŒ–åå¾ˆå¿«ç¨³å®š

### 3. å¯¹æ¯”æµ‹è¯•

åŒæ—¶æµ‹è¯•æ–¹æ³•1å’Œæ–¹æ³•2ï¼Œå¯¹æ¯”ï¼š
```
æ–¹æ³•1ç¨³å®šæ€§ï¼šâ­â­â­â­â­ (5æ˜Ÿ)
æ–¹æ³•2ç¨³å®šæ€§ï¼šâ­â­â­â­â­ (5æ˜Ÿï¼Œä¼˜åŒ–å)
```

### 4. è°ƒè¯•è¾“å‡º

å¦‚éœ€è°ƒè¯•ï¼Œå¯æŸ¥çœ‹ï¼š
```
[Method2] HR: 78.3 BPM | Peak Period: 77 samples (Valid)
```

æ³¨æ„è§‚å¯Ÿï¼š
- å¿ƒç‡å€¼æ˜¯å¦åœ¨åˆç†èŒƒå›´
- æ˜¯å¦æ ‡è®°ä¸º"Valid"
- Peak Periodæ˜¯å¦ç¨³å®š

---

## å¦‚æœä»æœ‰æ³¢åŠ¨

å¦‚æœä¼˜åŒ–åä»æœ‰æ³¢åŠ¨ï¼Œå¯èƒ½çš„åŸå› ï¼š

### 1. æ‰‹æŒ‡æ”¾ç½®ä¸ç¨³å®š
- ç¡®ä¿æ‰‹æŒ‡ç´§è´´ä¼ æ„Ÿå™¨
- ä¸è¦ç”¨åŠ›æŒ‰å‹
- ä¿æŒæ‰‹æŒ‡é™æ­¢

### 2. ä¿¡å·è´¨é‡å·®
- æ£€æŸ¥ç¯å¢ƒå…‰çº¿
- æ£€æŸ¥ä¼ æ„Ÿå™¨æ¸…æ´åº¦
- è°ƒæ•´LEDç”µæµï¼ˆåœ¨MAX30102é©±åŠ¨ä¸­ï¼‰

### 3. å‚æ•°éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´
- é™ä½`DPT_HR_EMA_ALPHA`åˆ°0.10
- å¢åŠ `DPT_MEDIAN_SIZE`åˆ°9æˆ–11
- é™ä½`DPT_MAX_HR_CHANGE`åˆ°6.0

### 4. æ·»åŠ é¢å¤–çš„æ˜¾ç¤ºå±‚å¹³æ»‘
åœ¨main.cä¸­æ·»åŠ ç±»ä¼¼æ–¹æ³•1çš„åŒå±‚å¹³æ»‘ï¼š
```c
#ifdef USE_ALGORITHM_METHOD2
    // æ·»åŠ æ˜¾ç¤ºå±‚å¹³æ»‘
    static float displayed_hr_m2 = 0.0f;
    if (DPT_IsHeartRateValid(&dpt_state)) {
        if (displayed_hr_m2 == 0.0f) {
            displayed_hr_m2 = heart_rate;
        } else {
            float hr_diff = fabsf(heart_rate - displayed_hr_m2);
            if (hr_diff > 2.0f) {
                displayed_hr_m2 = 0.1f * heart_rate + 0.9f * displayed_hr_m2;
            }
        }
        // ä½¿ç”¨displayed_hr_m2æ˜¾ç¤º
    }
#endif
```

---

## æ€§èƒ½å½±å“

ä¼˜åŒ–å¯¹æ€§èƒ½çš„å½±å“ï¼š
- **CPUå ç”¨**: +5% (å¢åŠ ä¸­ä½æ•°æ’åº)
- **å†…å­˜å ç”¨**: +28 bytes (é¢å¤–çš„ç¼“å†²åŒº)
- **å“åº”æ—¶é—´**: ç•¥å¾®å¢åŠ ï¼ˆæ›´å¼ºå¹³æ»‘çš„ä»£ä»·ï¼‰
- **ç¨³å®šæ€§**: æ˜¾è‘—æå‡ â¬†ï¸â¬†ï¸â¬†ï¸

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-01-15
**ä¼˜åŒ–æªæ–½**: 7é¡¹
**é¢„æœŸç¨³å®šæ€§æå‡**: 80%+

ç°åœ¨æ–¹æ³•2åº”è¯¥ä¸æ–¹æ³•1ä¸€æ ·ç¨³å®šäº†ï¼
