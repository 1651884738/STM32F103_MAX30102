# 硬件说明文档

## 概述

本文档详细介绍 MAX30102 心率血氧监测系统的硬件配置、连接方式和调试方法。

## 目录

1. [硬件清单](#1-硬件清单)
2. [引脚连接](#2-引脚连接)
3. [电路设计](#3-电路设计)
4. [硬件配置](#4-硬件配置)
5. [调试工具](#5-调试工具)
6. [常见问题](#6-常见问题)

---

## 1. 硬件清单

### 1.1 核心模块

| 项目 | 型号 | 数量 | 说明 |
|------|------|------|------|
| 微控制器 | STM32F103C8T6 | 1 | ARM Cortex-M3, 72MHz |
| 心率血氧传感器 | MAX30102 | 1 | 集成红光+红外LED |
| OLED显示屏 | 0.96" 128x64 | 1 | I2C接口 |
| 调试器 | ST-Link V2 | 1 | SWD接口 |

### 1.2 电源要求

| 模块 | 电压 | 电流 | 备注 |
|------|------|------|------|
| STM32F103 | 3.3V | ~50mA | 工作电流 |
| MAX30102 | 3.3V | ~10mA | LED关闭时 |
| MAX30102 | 3.3V | ~50mA | LED工作时（峰值）|
| OLED | 3.3V | ~20mA | 全屏点亮 |
| **总计** | **3.3V** | **~130mA** | 推荐 500mA 电源 |

### 1.3 外围元件（可选）

- 100nF 去耦电容 x 3（每个IC一个）
- 10μF 电源滤波电容 x 1
- 10kΩ I2C上拉电阻 x 2（部分模块已集成）
- LED指示灯 + 限流电阻（调试用）

---

## 2. 引脚连接

### 2.1 完整连接图

```
┌────────────────────────────────────────────┐
│           STM32F103C8T6                    │
│                                            │
│  PB6 ◄───────────► SCL  (MAX30102)        │
│  PB7 ◄───────────► SDA  (MAX30102)        │
│  PB1 ◄─────────── INT  (MAX30102, 可选)   │
│                                            │
│  PB8 ◄───────────► SCL  (OLED)            │
│  PB9 ◄───────────► SDA  (OLED)            │
│                                            │
│  PA2 ────────────► TX   (UART2)           │
│  PA3 ◄─────────── RX   (UART2)           │
│                                            │
│  PA13 ◄──────────► SWDIO (ST-Link)        │
│  PA14 ◄──────────► SWCLK (ST-Link)        │
│  GND  ◄──────────► GND   (ST-Link)        │
│  3.3V ◄──────────► 3.3V  (ST-Link)        │
└────────────────────────────────────────────┘
```

### 2.2 MAX30102 连接

| MAX30102 引脚 | STM32 引脚 | 功能 | 说明 |
|---------------|-----------|------|------|
| VIN | 3.3V | 电源 | 主电源 |
| GND | GND | 地 | 电源地 |
| SDA | PB7 | I2C数据 | 软件I2C |
| SCL | PB6 | I2C时钟 | 软件I2C |
| INT | PB1 | 中断输出 | 可选，数据就绪中断 |

**注意事项：**
- MAX30102 工作电压：1.8V I/O, 3.3V 电源
- I2C 地址：0x57 (7-bit)
- 上拉电阻：SDA/SCL 需要 4.7kΩ 上拉（模块通常已集成）

### 2.3 OLED 连接

| OLED 引脚 | STM32 引脚 | 功能 | 说明 |
|-----------|-----------|------|------|
| VCC | 3.3V | 电源 | 主电源 |
| GND | GND | 地 | 电源地 |
| SDA | PB9 | I2C数据 | 硬件I2C1 |
| SCL | PB8 | I2C时钟 | 硬件I2C1 |

**注意事项：**
- OLED I2C 地址：通常为 0x3C 或 0x78 (8-bit)
- 部分OLED需要5V供电，请确认规格

### 2.4 串口调试连接

| UART 引脚 | STM32 引脚 | 功能 | 说明 |
|-----------|-----------|------|------|
| TX | PA2 | 发送 | UART2_TX |
| RX | PA3 | 接收 | UART2_RX |
| GND | GND | 地 | 公共地 |

**串口参数：**
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验位：无

### 2.5 调试接口（SWD）

| ST-Link 引脚 | STM32 引脚 | 功能 |
|--------------|-----------|------|
| SWDIO | PA13 | 数据 |
| SWCLK | PA14 | 时钟 |
| GND | GND | 地 |
| 3.3V | 3.3V | 电源（可选）|
| NRST | NRST | 复位（可选）|

---

## 3. 电路设计

### 3.1 最小系统电路

```
              ┌──────────────────┐
    3.3V ─────┤VDD         VSS├──── GND
              │                 │
    BOOT0 ────┤BOOT0       PA13├──── SWDIO
      │       │            PA14├──── SWCLK
     GND      │                 │
              │   STM32F103C8T6 │
    8MHz ─────┤OSC_IN      PB6 ├──── SCL (MAX30102)
    XTAL      │OSC_OUT     PB7 ├──── SDA (MAX30102)
              │            PB8 ├──── SCL (OLED)
    RESET ────┤NRST        PB9 ├──── SDA (OLED)
      │       │            PA2 ├──── TX (UART)
     10kΩ     │            PA3 ├──── RX (UART)
      │       └──────────────────┘
     3.3V
```

### 3.2 MAX30102 接口电路

```
              ┌──────────────────┐
    3.3V ─────┤VDD         INT├──── PB1 (STM32)
     │        │                 │
   100nF      │   MAX30102      │
     │        │                 │
    GND ──────┤GND         SDA├──── PB7 (STM32)
              │            SCL├──── PB6 (STM32)
              └──────────────────┘
                 │       │
              4.7kΩ   4.7kΩ (上拉，可选)
                 │       │
               3.3V    3.3V
```

### 3.3 OLED 接口电路

```
              ┌──────────────────┐
    3.3V ─────┤VCC             │
     │        │                 │
   100nF      │   OLED 0.96"    │
     │        │   128x64        │
    GND ──────┤GND         SDA├──── PB9 (STM32)
              │            SCL├──── PB8 (STM32)
              └──────────────────┘
```

### 3.4 电源电路

```
              ┌──────────────────┐
USB 5V ───────┤VIN         VOUT├──── 3.3V
              │   AMS1117-3.3   │      │
    GND ──────┤GND         GND├───────┤
              └──────────────────┘      │
                 │                      │
              10μF(IN)              100nF + 10μF(OUT)
                 │                      │
                GND                    GND
```

---

## 4. 硬件配置

### 4.1 STM32F103 时钟配置

```c
系统时钟源：外部晶振 (8MHz)
PLL 倍频：9倍
系统时钟：72MHz
AHB 时钟：72MHz
APB1 时钟：36MHz
APB2 时钟：72MHz
```

### 4.2 GPIO 配置

| 引脚 | 模式 | 速度 | 上拉/下拉 | 功能 |
|------|------|------|-----------|------|
| PB6 | Output OD | 50MHz | Pull-up | I2C SCL (MAX30102) |
| PB7 | Output OD | 50MHz | Pull-up | I2C SDA (MAX30102) |
| PB8 | Alternate OD | 50MHz | Pull-up | I2C1 SCL (OLED) |
| PB9 | Alternate OD | 50MHz | Pull-up | I2C1 SDA (OLED) |
| PB1 | Input | - | Pull-up | EXTI (MAX30102 INT) |
| PA2 | Alternate PP | 50MHz | - | USART2 TX |
| PA3 | Input Floating | - | - | USART2 RX |

### 4.3 I2C 配置

**软件 I2C (MAX30102):**
```c
时钟频率：100 kHz (标准模式)
SCL 引脚：PB6
SDA 引脚：PB7
延时函数：软件延时（微秒级）
```

**硬件 I2C1 (OLED):**
```c
时钟频率：400 kHz (快速模式)
SCL 引脚：PB8
SDA 引脚：PB9
DMA：不使用
```

### 4.4 UART2 配置

```c
波特率：115200
数据位：8
停止位：1
校验位：无
流控：无
```

### 4.5 定时器配置

**TIM2 (用于软件I2C延时):**
```c
预分频：72 (1MHz 计数频率)
周期：0xFFFF (自由运行)
用途：微秒级延时
```

---

## 5. 调试工具

### 5.1 硬件调试工具

**1. ST-Link V2**
- 功能：程序下载、在线调试、SWD接口
- 连接：SWDIO, SWCLK, GND, 3.3V

**2. USB转串口模块**
- 芯片：CH340G / CP2102 / FT232
- 用途：串口调试输出
- 连接：TX→RX, RX→TX, GND

**3. 逻辑分析仪**
- 用途：I2C信号分析
- 推荐：支持I2C协议解码

**4. 示波器**
- 用途：PPG信号波形查看
- 通道：至少2通道（红光+红外）

### 5.2 软件调试工具

**1. STM32CubeIDE**
- 集成开发环境
- 支持断点调试
- 支持实时变量查看

**2. Serial Port Monitor**
- 串口数据监控
- 推荐：PuTTY, RealTerm, CoolTerm

**3. Python数据采集**
```python
import serial
import matplotlib.pyplot as plt

ser = serial.Serial('COM3', 115200)
# 数据采集和绘图
```

---

## 6. 常见问题

### 6.1 MAX30102 无法识别

**现象：** Part ID 读取失败或为 0xFF

**排查步骤：**
1. 检查供电：使用万用表测量 VIN 引脚，应为 3.3V
2. 检查I2C连接：
   - SCL/SDA 是否接对
   - 是否有上拉电阻（4.7kΩ）
3. 检查I2C通信：
   - 使用逻辑分析仪查看波形
   - 确认时序正确
4. 检查模块：更换 MAX30102 模块测试

### 6.2 OLED 无显示

**现象：** OLED 屏幕黑屏或花屏

**排查步骤：**
1. 检查供电：确认电压为 3.3V 或 5V（根据规格）
2. 检查I2C地址：
   - 尝试 0x3C 和 0x78
   - 使用I2C扫描程序
3. 检查初始化代码：
   - 初始化顺序是否正确
   - 延时是否足够（至少20ms）
4. 检查硬件：更换OLED模块

### 6.3 心率读数不准

**现象：** 心率值偏差较大或不稳定

**解决方法：**
1. **手指放置**：
   - 确保手指紧贴传感器
   - 不要用力按压
   - 手指保持静止
2. **环境光**：
   - 避免强光直射
   - 使用遮光罩
3. **参数调整**：
   - 降低 `PEAK_THRESHOLD` (0.4-0.5)
   - 调整 `MIN_PEAK_DISTANCE`
4. **LED电流**：
   - 调整 LED 电流（0x24 → 0x2F）

### 6.4 串口无输出

**现象：** 串口助手无数据

**排查步骤：**
1. 检查串口参数：115200, 8N1
2. 检查TX/RX连接：是否交叉连接
3. 检查 printf 重定向：确认已实现 `fputc`
4. 检查时钟：UART 时钟是否使能

### 6.5 程序无法下载

**现象：** ST-Link 连接失败

**解决方法：**
1. **检查连接**：
   - SWDIO, SWCLK, GND 是否连接
   - 线缆是否接触良好
2. **检查BOOT**：
   - BOOT0 应接 GND（正常模式）
3. **复位芯片**：
   - 按住 RESET 后重新连接
4. **更换调试器**：
   - 尝试不同的 ST-Link

---

## 7. PCB 设计建议

### 7.1 布局建议

```
┌─────────────────────────────────┐
│  [MAX30102]    [OLED]           │
│      ↑            ↑             │
│      │            │             │
│  [STM32F103C8T6]  [LDO]         │
│      │            │             │
│      ↓            ↓             │
│  [USB接口]    [电源指示LED]    │
└─────────────────────────────────┘
```

**要点：**
- MAX30102 靠近 MCU，缩短 I2C 走线
- 电源去耦电容靠近芯片
- 模拟地和数字地分开
- 避免高频信号干扰 MAX30102

### 7.2 PCB 走线

- **电源线宽**：≥ 20mil (0.5mm)
- **I2C 走线**：等长，≥ 10mil
- **地平面**：完整的地平面
- **过孔**：最小 0.3mm

---

## 8. 购买清单

### 8.1 推荐购买链接

| 项目 | 参考价格 | 备注 |
|------|----------|------|
| STM32F103C8T6 最小系统板 | ¥12 | 带USB和调试接口 |
| MAX30102 模块 | ¥8 | 带上拉电阻 |
| 0.96" OLED (I2C) | ¥10 | 白色或蓝色 |
| ST-Link V2 | ¥15 | 调试下载器 |
| USB转串口 (CH340G) | ¥5 | 串口调试 |
| 杜邦线 | ¥5 | 公母线若干 |
| **总计** | **~¥55** | 基础套件 |

---

## 9. 参考资料

1. [STM32F103C8T6 数据手册](https://www.st.com/)
2. [MAX30102 数据手册](https://www.maximintegrated.com/)
3. [I2C 总线规范](https://www.nxp.com/)
4. [OLED 驱动芯片 SSD1306 规格书](https://www.solomon-systech.com/)

---

**文档版本：** 1.0
**最后更新：** 2025-01
**作者：** Claude Code + Your Name
